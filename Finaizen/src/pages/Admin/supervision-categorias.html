<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisión de IA | Admin Panel</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/dashboard.css">

    <style>
        #sidebar-container { position: fixed; top: 0; left: 0; height: 100vh; z-index: 1000; }
        .main-content { margin-left: 290px; padding: 30px; display: flex; flex-direction: column; gap: 30px; }

        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .kpi-card { background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border-left: 5px solid #1a2a44; }
        .kpi-card h4 { margin: 0 0 10px 0; color: #555; }
        .kpi-card p { margin: 0; font-size: 2.5em; font-weight: 600; color: #1a2a44; }
        .kpi-card span { font-size: 0.7em; color: #888; }
        .kpi-card .problem-list { font-size: 1em; list-style-type: none; padding-left: 0; }

        .card { background-color: #fff; border-radius: 12px; padding: 1.5em; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* --- Nuevos Estilos: Campo de Pruebas --- */
        .ai-playground { display: flex; gap: 15px; align-items: flex-end; }
        .ai-playground .input-group { flex-grow: 1; }
        .ai-playground label { display: block; margin-bottom: 5px; font-weight: 500; }
        .ai-playground input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
        .ai-playground button { padding: 10px 20px; border: none; background-color: #1a2a44; color: white; border-radius: 8px; cursor: pointer; }
        #ai-prediction-result { margin-top: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 8px; display: none; }

        .charts-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; align-items: start; margin-top: 20px; }

        .filters-bar { display: flex; gap: 20px; margin-bottom: 20px; }
        .filters-bar select, .filters-bar input { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; }
        
        .supervision-table { width: 100%; border-collapse: collapse; }
        .supervision-table th, .supervision-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .confidence-level { padding: 4px 8px; border-radius: 12px; font-weight: 500; }
        .confidence-level.alta { background-color: #d4edda; color: #155724; }
        .confidence-level.media { background-color: #fff3cd; color: #856404; }
        .confidence-level.baja { background-color: #f8d7da; color: #721c24; }
        .action-link { color: #007bff; cursor: pointer; text-decoration: underline; }

        /* --- Nuevos Estilos: Modal de Corrección --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; }
        .modal-content h3 { margin-top: 0; }
        .modal-content .form-group { margin-bottom: 15px; }
        .modal-content label { display: block; margin-bottom: 5px; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .modal-actions { text-align: right; margin-top: 20px; }
        .modal-actions button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; }
        .modal-actions .btn-save { background-color: #28a745; color: white; }
        .modal-actions .btn-cancel { background-color: #ccc; margin-left: 10px; }

    </style>
</head>
<body>

<div id="correction-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Corregir Clasificación</h3>
        <p><strong>Descripción Original:</strong> <span id="modal-original-desc"></span></p>
        <div class="form-group">
            <label for="modal-keyword">Palabra Clave</label>
            <input type="text" id="modal-keyword">
        </div>
        <div class="form-group">
            <label for="modal-category">Categoría General</label>
            <select id="modal-category">
                <option>Entretenimiento</option>
                <option>Salud</option>
                <option>Transporte</option>
                <option>Supermercado</option>
                <option>Suscripciones</option>
                <option>Otros</option>
            </select>
        </div>
        <div class="form-group">
            <input type="checkbox" id="modal-create-rule">
            <label for="modal-create-rule">Crear regla permanente para esta palabra clave</label>
        </div>
        <div class="modal-actions">
            <button id="modal-cancel" class="btn-cancel">Cancelar</button>
            <button id="modal-save" class="btn-save">Guardar Corrección</button>
        </div>
    </div>
</div>

<div class="container">
    <div id="sidebar-container"></div>
    <main class="main-content">
        
        <div class="kpi-container">
            <div class="kpi-card">
                <h4>Precisión del modelo</h4>
                <p>96.5%</p>
                <span>Últimos 7 días</span>
            </div>
            <div class="kpi-card">
                <h4>Correcciones manuales</h4>
                <p>82</p>
                <span>Últimos 7 días</span>
            </div>
            <div class="kpi-card">
                <h4>Categorías problemáticas</h4>
                <ul class="problem-list">
                    <li>1. Suscripciones</li>
                    <li>2. Transporte</li>
                </ul>
            </div>
        </div>

        <section class="card">
            <h4>Campo de Pruebas de la IA</h4>
            <div class="ai-playground">
                <div class="input-group">
                    <label for="ai-test-input">Ingresa una descripción para probar:</label>
                    <input type="text" id="ai-test-input" placeholder="Ej: 'Pago de la luz'">
                </div>
                <button id="ai-test-btn">Probar</button>
            </div>
            <div id="ai-prediction-result"></div>
        </section>

        <div class="charts-grid">
            <section class="card">
                <h4>Distribución de Confianza</h4>
                <canvas id="confidenceChart"></canvas>
            </section>
            <section class="card">
                <h4>Tendencia de Correcciones</h4>
                <canvas id="correctionsTrendChart"></canvas>
            </section>
        </div>

        <section class="card">
            <div class="filters-bar">
                <select id="confidence-filter">
                    <option value="todos">Todos los niveles</option>
                    <option value="baja">Confianza Baja</option>
                    <option value="media">Confianza Media</option>
                    <option value="alta">Confianza Alta</option>
                </select>
                <input type="text" id="search-input" placeholder="Buscar por descripción...">
            </div>

            <table class="supervision-table">
                <thead>
                    <tr>
                        <th>Descripción del usuario</th>
                        <th>Palabra clave IA</th>
                        <th>Categoría general IA</th>
                        <th>Confianza</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="supervision-tbody"></tbody>
            </table>
        </section>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    fetch('../../components/sidebar_admin.html')
        .then(response => response.ok ? response.text() : Promise.reject('Sidebar no encontrado'))
        .then(data => document.getElementById('sidebar-container').innerHTML = data)
        .catch(error => console.error('Error al cargar sidebar:', error));

    const transactions = [
        { id: 1, desc: '"Salida al cine"', keyword: '"Cine"', category: 'Entretenimiento', confidence: 'alta', score: 98, status: 'Validado' },
        { id: 2, desc: '"Comprar medicina"', keyword: '"Medicina"', category: 'Salud', confidence: 'media', score: 74, status: 'Corregir' },
        { id: 3, desc: '"Pago de suscripcion spotify"', keyword: '"Pago"', category: 'Otros', confidence: 'baja', score: 45, status: 'Corregir y crear regla' },
        { id: 4, desc: '"Uber a casa"', keyword: '"Uber"', category: 'Transporte', confidence: 'media', score: 68, status: 'Corregir' },
        { id: 5, desc: '"Supermaxi compra semanal"', keyword: '"Supermaxi"', category: 'Supermercado', confidence: 'alta', score: 99, status: 'Validado' },
        { id: 6, desc: '"Cuota del gym"', keyword: '"Gym"', category: 'Salud', confidence: 'alta', score: 92, status: 'Validado' },
        { id: 7, desc: '"Netflix mensual"', keyword: '"Netflix"', category: 'Otros', confidence: 'baja', score: 51, status: 'Corregir y crear regla' }
    ];

    const tbody = document.getElementById('supervision-tbody');
    const confidenceFilter = document.getElementById('confidence-filter');
    const searchInput = document.getElementById('search-input');
    const modal = document.getElementById('correction-modal');

    function renderTable() {
        const filterValue = confidenceFilter.value;
        const searchValue = searchInput.value.toLowerCase();
        tbody.innerHTML = '';

        transactions
            .filter(t => (filterValue === 'todos' || t.confidence === filterValue) && t.desc.toLowerCase().includes(searchValue))
            .forEach(t => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${t.desc}</td>
                    <td>${t.keyword}</td>
                    <td>${t.category}</td>
                    <td><span class="confidence-level ${t.confidence}">${t.confidence.charAt(0).toUpperCase() + t.confidence.slice(1)} (${t.score}%)</span></td>
                    <td><a class="action-link" data-id="${t.id}">${t.status}</a></td>
                `;
                tbody.appendChild(row);
            });
    }
    
    tbody.addEventListener('click', (e) => {
        if (e.target.classList.contains('action-link')) {
            const transactionId = parseInt(e.target.dataset.id);
            const transaction = transactions.find(t => t.id === transactionId);
            if (transaction && transaction.status !== 'Validado') {
                openCorrectionModal(transaction);
            }
        }
    });

    function openCorrectionModal(transaction) {
        document.getElementById('modal-original-desc').textContent = transaction.desc;
        document.getElementById('modal-keyword').value = transaction.keyword.replace(/"/g, '');
        document.getElementById('modal-category').value = transaction.category;
        document.getElementById('modal-create-rule').checked = transaction.status === 'Corregir y crear regla';
        modal.style.display = 'flex';
    }

    function closeCorrectionModal() {
        modal.style.display = 'none';
    }

    document.getElementById('modal-cancel').addEventListener('click', closeCorrectionModal);
    document.getElementById('modal-save').addEventListener('click', () => {
        // Aquí iría la lógica para guardar los cambios en la BD
        console.log("Corrección guardada.");
        closeCorrectionModal();
    });

    document.getElementById('ai-test-btn').addEventListener('click', () => {
        const input = document.getElementById('ai-test-input').value;
        const resultDiv = document.getElementById('ai-prediction-result');
        if (!input) return;
        
        // Simulación de una llamada a la API de la IA
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<strong>Predicción para "${input}":</strong><br>
                               Palabra Clave: "Pago"<br>
                               Categoría: "Servicios"<br>
                               Confianza: Media (65%)`;
    });

    function renderCharts() {
        const confidenceCounts = transactions.reduce((acc, t) => { acc[t.confidence] = (acc[t.confidence] || 0) + 1; return acc; }, {});
        new Chart(document.getElementById('confidenceChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Alta', 'Media', 'Baja'],
                datasets: [{
                    data: [confidenceCounts.alta || 0, confidenceCounts.media || 0, confidenceCounts.baja || 0],
                    backgroundColor: ['#d4edda', '#fff3cd', '#f8d7da'],
                    borderColor: ['#155724', '#856404', '#721c24'],
                    borderWidth: 1
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top' } } }
        });
        
        new Chart(document.getElementById('correctionsTrendChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: ['Jul', 'Ago', 'Sep', 'Oct'],
                datasets: [{
                    label: 'Correcciones Manuales',
                    data: [120, 95, 88, 82],
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });
    }

    confidenceFilter.addEventListener('change', renderTable);
    searchInput.addEventListener('input', renderTable);

    window.onload = () => {
        renderTable();
        renderCharts();
    };
</script>
</body>
</html>

