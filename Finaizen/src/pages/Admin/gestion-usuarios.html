<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios | Admin Panel</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/dashboard.css">

    <style>
        #sidebar-container { position: fixed; top: 0; left: 0; height: 100vh; z-index: 1000; }
        .main-content { margin-left: 290px; padding: 30px; display: flex; flex-direction: column; gap: 30px; }

        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .kpi-card { background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border-left: 5px solid #17a2b8; }
        .kpi-card h4 { margin: 0 0 10px 0; color: #555; }
        .kpi-card p { margin: 0; font-size: 2.5em; font-weight: 600; color: #1a2a44; }

        .card { background-color: #fff; border-radius: 12px; padding: 1.5em; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filters-bar { display: flex; gap: 20px; align-items: center; }
        .filters-bar select, .filters-bar input { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; }
        
        #btn-invite-user { padding: 10px 20px; background-color: #1a2a44; color: white; border: none; border-radius: 8px; cursor: pointer; }

        .user-table { width: 100%; border-collapse: collapse; }
        .user-table th, .user-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        
        .status, .role { padding: 5px 12px; border-radius: 15px; font-weight: 500; font-size: 0.9em; text-align: center; display: inline-block; }
        .status.activo { background-color: #d4edda; color: #155724; }
        .status.suspendido { background-color: #e2e3e5; color: #383d41; }
        .role.usuario { background-color: #cce5ff; color: #004085; }
        .role.admin { background-color: #f5c6cb; color: #721c24; }
        .role.analista { background-color: #d1ecf1; color: #0c5460; }
        .role.supervisor { background-color: #fff3cd; color: #856404; }
        .role.soporte { background-color: #d6d8db; color: #383d41; }

        .actions-dropdown { position: relative; }
        .actions-dropdown button { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        .dropdown-menu { display: none; position: absolute; right: 0; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; }
        .dropdown-menu.show { display: block; }
        .dropdown-menu a { display: block; padding: 10px 20px; text-decoration: none; color: black; }
        .dropdown-menu a:hover { background-color: #f1f1f1; }

        /* Estilos del Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; }
        .modal-actions { text-align: right; margin-top: 20px; }
        .modal-actions button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="action-modal" class="modal-overlay">
    <!-- El contenido del modal se generará dinámicamente con JS -->
</div>

<div class="container">
    <div id="sidebar-container"></div>
    <main class="main-content">
        
        <div class="kpi-container">
            <div class="kpi-card"><h4>Total de Usuarios</h4><p id="kpi-total"></p></div>
            <div class="kpi-card"><h4>Usuarios Activos</h4><p id="kpi-active"></p></div>
            <div class="kpi-card"><h4>Usuarios Suspendidos</h4><p id="kpi-suspended"></p></div>
        </div>

        <section class="card">
            <div class="table-header">
                <div class="filters-bar">
                    <input type="text" id="search-input" placeholder="Buscar por nombre o email...">
                    <select id="role-filter"><option value="todos">Todos los roles</option></select>
                    <select id="status-filter">
                        <option value="todos">Todos los estados</option>
                        <option value="Activo">Activo</option>
                        <option value="Suspendido">Suspendido</option>
                    </select>
                </div>
                <button id="btn-invite-user">Invitar Nuevo Usuario</button>
            </div>

            <table class="user-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Fecha Registro</th>
                        <th>Estado</th>
                        <th>Rol</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="user-tbody"></tbody>
            </table>
        </section>
    </main>
</div>

<script>
    fetch('../../components/sidebar_admin.html')
        .then(response => response.ok ? response.text() : Promise.reject('Sidebar no encontrado'))
        .then(data => document.getElementById('sidebar-container').innerHTML = data)
        .catch(error => console.error('Error al cargar sidebar:', error));

    const roles = {
        'Usuario': 'usuario',
        'Admin TI': 'admin',
        'Analista de Datos': 'analista',
        'Supervisor IA': 'supervisor',
        'Agente de Soporte': 'soporte'
    };

    let users = [
        { id: 1, name: 'Carlos Mendoza', email: 'carlos.m@email.com', date: '2024-08-15', status: 'Activo', role: 'Usuario' },
        { id: 2, name: 'Ana Torres', email: 'ana.t@email.com', date: '2024-09-22', status: 'Activo', role: 'Analista de Datos' },
        { id: 3, name: 'Luis García', email: 'luis.g@email.com', date: '2024-07-10', status: 'Activo', role: 'Usuario' },
        { id: 4, name: 'Javier López', email: 'javier.l@email.com', date: '2024-08-30', status: 'Suspendido', role: 'Usuario' },
        { id: 5, name: 'Carmen Ruiz', email: 'carmen.r@email.com', date: '2024-09-15', status: 'Activo', role: 'Supervisor IA' },
        { id: 6, name: 'Elena Morales', email: 'elena.m@email.com', date: '2024-08-18', status: 'Activo', role: 'Agente de Soporte' },
        { id: 7, name: 'Isabel Díaz', email: 'isabel.d@email.com', date: '2024-08-25', status: 'Suspendido', role: 'Usuario' }
    ];

    const tbody = document.getElementById('user-tbody');
    const roleFilter = document.getElementById('role-filter');

    function renderTable() {
        const searchValue = document.getElementById('search-input').value.toLowerCase();
        const roleValue = roleFilter.value;
        const statusValue = document.getElementById('status-filter').value;
        tbody.innerHTML = '';
        
        users
            .filter(u => 
                (u.name.toLowerCase().includes(searchValue) || u.email.toLowerCase().includes(searchValue)) &&
                (roleValue === 'todos' || u.role === roleValue) &&
                (statusValue === 'todos' || u.status === statusValue)
            )
            .forEach(u => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${u.name}</td><td>${u.email}</td><td>${u.date}</td>
                    <td><span class="status ${u.status.toLowerCase()}">${u.status}</span></td>
                    <td><span class="role ${roles[u.role] || 'usuario'}">${u.role}</span></td>
                    <td class="actions-dropdown">
                        <button onclick="toggleDropdown(${u.id})">⋮</button>
                        <div id="dropdown-${u.id}" class="dropdown-menu">
                            <a href="#" onclick="openModal('view', ${u.id})">Ver Perfil</a>
                            <a href="#" onclick="openModal('role', ${u.id})">Modificar Rol</a>
                            <a href="#" onclick="openModal('${u.status === 'Activo' ? 'suspend' : 'reactivate'}', ${u.id})">${u.status === 'Activo' ? 'Suspender' : 'Reactivar'}</a>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        updateKPIs();
    }
    
    function updateKPIs() {
        document.getElementById('kpi-total').textContent = users.length;
        document.getElementById('kpi-active').textContent = users.filter(u => u.status === 'Activo').length;
        document.getElementById('kpi-suspended').textContent = users.filter(u => u.status === 'Suspendido').length;
    }

    function populateRoleFilter() {
        Object.keys(roles).forEach(role => {
            roleFilter.innerHTML += `<option value="${role}">${role}</option>`;
        });
    }

    function toggleDropdown(userId) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            if (menu.id !== `dropdown-${userId}`) menu.classList.remove('show');
        });
        document.getElementById(`dropdown-${userId}`).classList.toggle('show');
    }

    function openModal(type, userId) {
        const user = users.find(u => u.id === userId);
        const modal = document.getElementById('action-modal');
        let content = '';

        if (type === 'view') {
            content = `
                <div class="modal-content">
                    <h3>Perfil de Usuario</h3>
                    <p><strong>Nombre:</strong> ${user.name}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Rol:</strong> ${user.role}</p>
                    <p><strong>Estado:</strong> ${user.status}</p>
                    <p><strong>Miembro desde:</strong> ${user.date}</p>
                    <div class="modal-actions"><button onclick="closeModal()">Cerrar</button></div>
                </div>`;
        } else if (type === 'role') {
            let roleOptions = Object.keys(roles).map(r => `<option value="${r}" ${user.role === r ? 'selected' : ''}>${r}</option>`).join('');
            content = `
                <div class="modal-content">
                    <h3>Modificar Rol de ${user.name}</h3>
                    <select id="new-role-select">${roleOptions}</select>
                    <div class="modal-actions">
                        <button onclick="closeModal()">Cancelar</button>
                        <button onclick="updateUser(${userId}, 'role')">Guardar</button>
                    </div>
                </div>`;
        } else if (type === 'suspend' || type === 'reactivate') {
            const actionText = type === 'suspend' ? 'suspender' : 'reactivar';
            content = `
                <div class="modal-content">
                    <h3>Confirmar Acción</h3>
                    <p>¿Estás seguro de que quieres ${actionText} a <strong>${user.name}</strong>?</p>
                    <div class="modal-actions">
                        <button onclick="closeModal()">Cancelar</button>
                        <button onclick="updateUser(${userId}, '${type}')">Confirmar</button>
                    </div>
                </div>`;
        } else if (type === 'invite') {
             content = `
                <div class="modal-content">
                    <h3>Invitar Nuevo Usuario</h3>
                    <input type="email" id="invite-email" placeholder="Email del usuario" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                     <select id="invite-role-select">${Object.keys(roles).map(r => `<option value="${r}">${r}</option>`).join('')}</select>
                    <div class="modal-actions">
                        <button onclick="closeModal()">Cancelar</button>
                        <button onclick="updateUser(null, 'invite')">Enviar Invitación</button>
                    </div>
                </div>`;
        }
        
        modal.innerHTML = content;
        modal.style.display = 'flex';
    }

    function updateUser(userId, actionType) {
        if (actionType === 'role') {
            const newRole = document.getElementById('new-role-select').value;
            const userIndex = users.findIndex(u => u.id === userId);
            users[userIndex].role = newRole;
        } else if (actionType === 'suspend') {
            users.find(u => u.id === userId).status = 'Suspendido';
        } else if (actionType === 'reactivate') {
            users.find(u => u.id === userId).status = 'Activo';
        } else if (actionType === 'invite') {
            const email = document.getElementById('invite-email').value;
            const role = document.getElementById('invite-role-select').value;
            console.log(`Invitación enviada a ${email} con el rol de ${role}.`);
        }
        renderTable();
        closeModal();
    }
    
    function closeModal() { document.getElementById('action-modal').style.display = 'none'; }
    
    document.getElementById('search-input').addEventListener('input', renderTable);
    document.getElementById('role-filter').addEventListener('change', renderTable);
    document.getElementById('status-filter').addEventListener('change', renderTable);
    document.getElementById('btn-invite-user').addEventListener('click', () => openModal('invite', null));

    window.onload = () => {
        populateRoleFilter();
        renderTable();
    };
</script>
</body>
</html>
